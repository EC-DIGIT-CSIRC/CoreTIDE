required: 
  - condition
  - response

patternProperties:
  "rule_id::.+$":
    title: Internal Defender for Endpoint Rule ID
    type: integer
    description: |
      IMPORTANT: This is used by the automation to correctly
      Target the rule on SentinelOne, which uses its own ID system. 
      This key will appear as many tenant as this rule is deployed to.
      Do not alter this field manually, or create new fields.

if:
  properties:
    condition:
      properties:
        correlation:
          properties:
            entity:
              enum: ["Endpoint", "Ip", "None", "Storyline", "User"]
then:
  not:
    required: ["response"]
    
else:
    required: ["response"]

properties:
  schema:
    title: Schema identifier and version
    type: string
    description: Identifier of the schema at its current version 
    const: sentinel_one::1.0

  status: 
    title: Status of the use-case
    type: string
    description: Define the status according to use case development life cycle process
    tide.vocab: true
    example: STAGING
    default: DEVELOPMENT

  contributors:
    title: Development Contributors
    type: array
    description: Individuals who supported creating, enriching or tuning the detection. 
    items:
      type: string
      format: email

  tenants: 
    title: Target Tenants
    icon: üè¢
    description: |
      Override the default organizations and deploy to selected tenants only.
    type: array
    tide.config.system.tenants: defender_for_endpoint

  flags:
    title: Flags
    icon: üö©
    description: Flags allow to customize the rule behaviour using the modifiers framework
    type: array
    tide.config.parameter-list: systems.defender_for_endpoint.platform.flags

  details:
    title: Rule Details
    description: |
      You may use these attributes to optionally override them, if not they will be
      retrieved from the relevant existing MDR attributes.
    type: object
    properties:

      name:
        title: Rule Name Override
        description: |
          Overrides the MDR Name which is used by default as the rule name
        type: string
      
      description:
        title: Rule Description Override
        description: |
          Overrides the MDR Name which is used by default as the rule name
        type: string
        tide.template.multiline : True
      
      severity:
        title: Rule Severity Override
        description: |
          Overrides the MDR severity value which is used by default as the rule name
        type: string
        enum: 
          - Low
          - Medium
          - High
          - Critical
      
      expiration:
        title: Expiration Date
        description:
          Rules are considered Permanent until a date is specified in this field,
          then they become Temporary.
          Expects YYYY/MM/DD, at most 6 months from the time of deployment.
        type: string
        pattern: ^\d{4}\-(0[1-9]|1[012])\-(0[1-9]|[12][0-9]|3[01])$

  condition:
    title: Rule Condition
    description: |
      Configurations for the custom rule. Supports Single Event and Correlation
      rule types. 

      ‚ö†Ô∏è Once a rule condition is selected, you can't change it during development
      as it will fail any further updates. You'll need to delete your rule and start over, 
      if you wish you continue in the same file you'll need to delete any rule_id that was
      added by the deployer to allow it to deploy a new one. 
    type: object
    required: 
      - type
    
    if:
      properties:
        type:
          enum: [Single Event]
    then:
      required: [single_event]
      not:
        required: [correlation]
    else:
      required: [correlation]
      not:
        required: [single_event]

    properties:

      type:
        title: Detection Type
        type: string
        enum:
          - Single Event
          - Correlation
        enumMarkdown:
          - Matches against a single query
          - Allows correlating around entities and using multiple subqueries

      single_event:
        title: Single Event Rule Type
        description: |
          Use this Rule Type if you wish to generate one alert
          for every match of the query, without further correlations
        type: object
        tide.template.spacer: False
        required: 
          - query
        properties:

          query:
            title: S1QL Query (2.0)
            description: |
              S1 Query Language Version 2.0 Query. Version 1.0 will not be supported.
            type: string
            tide.template.multiline: True

      correlation: 
        title: Correlation Rule Type
        description: |
          Create a custom detection rule that correlates multiple events over time.
        type: object
        required:
          - entity
          - match_in_order
          - time_window
          - sub_queries
        properties:

          entity:
            title: Correlation Entity
            description: |
              A common entity used to group matching events.
              IMPORTANT: To use the response section, you must select a Process entity
            type: string
            enum: 
              - Process
              - User
              - Ip
              - Endpoint
              - Storyline
              - None
            markdownEnumDescriptions:
              - "### Process Entity\n**Fields included** : `agent.uuid` `src.process.uid`\n**Relationship between fields** : `And`"
              - "### User Entity\n**Fields included** : `actor.user.name` `src.process.user` `tgt.process.user` `src.process.user` `event.login.userName`\n**Relationship between fields** : `Or`"
              - "### IP Entity\n**Fields included** : `src_endpoint.ip` `dst_endpoint.ip` `device.ip` `src.ip.address` `dst.ip.address`\n**Relationship between fields** : `Or`"
              - "### Device Entity\n**Fields included** : `agent.uuid` `device.uid`\n**Relationship between fields** : `Or`"
              - "### Storyline Entity\n**Fields included** : `src.process.storyline.id` `agent.uuid`\n**Relationship between fields** : `And`"
              - "### No Correlation Entity"

          match_in_order:
            title: Match in Order
            description: |
              Set to True to require subqueries to match in sequence to trigger an alert.
            type: boolean
            default: True
          
          time_window:
            title: Time Window
            description: |
              The period of time in minutes in which subqueries must match to trigger an alert.
            type: string
            enum: 
              - 10m
              - 30m
              - 1h
              - 4h
              - 8h
              - 12h
          
          sub_queries:
            title: Sub Queries
            description: |
              The list of subqueries for the custom detection rule.
            type: array
            items:
              type: object
              required:
                - query
                - matches_required
              properties:

                query:
                  title: S1QL 2.0 Sub Query 
                  description: |
                    Sub Query, in S1QL 2.0. 1.0 not suported. 
                  type: string
                  tide.template.multiline: True
                
                matches_required:
                  title: Matches Required
                  description: |
                    The number of times the subquery must match.
                  type: integer
                  default: 1
          
      cool_off:
        title: Cool off Period
        description: 
          Receive only one alert and suppress additional alerts when a rule is
          triggered multiple times during the cool-off period. Mitigation actions
          set in the rule will not be applied to suppressed alerts.

          Expects a value in minute or hour, from 1m to 1440m or 1h to 24h.
        type: string
        tide.template.spacer: True
        pattern: ^(([1-9][0-9]{0,2}m|1[0-3][0-9]{2}m|14[0-3][0-9]m|1440m)|([1-9]h|1[0-9]h|2[0-4]h))$

  response:
    title: Active Response
    description: |
      When this rule matches a SentinelOne endpoint event,
      these Storyline Active Responses will be performed.
      Note: XDR response actions triggered by STAR rules can be configured from the Markteplace package.
    type: object 
    required:
      - treat_as_threat
      - network_quarantine
    properties:

      treat_as_threat:
        title: Treat as threat
        description: |
          If selected, the Agent generates a threat from the alert and applies a selected policy.
        type: [string, boolean]
        enum:
          - False
          - Suspicious
          - Malicious
        markdownEnumDescriptions:
          - Do not treat as threat
          - Suspicious Threat Policy
          - Malicious Threat Policy 
        default: False
       
      network_quarantine:
        title: Network Quarantine
        description: |
          If selected, the system automatically quarantines the alerted endpoints.
          You can reconnect the endpoints from the Sentinels page or Endpoint Details.
        type: boolean
        default: False